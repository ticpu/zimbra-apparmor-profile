# Last Modified: Mon Jan  8 19:11:30 2024
#include <tunables/global>

profile zimbra_jvm {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/zimbra-ptrace>

  capability dac_override,
  capability dac_read_search,
  capability kill,
  capability setgid,
  capability setuid,

  signal receive set=kill peer=/opt/zimbra/libexec/zmmailboxdmgr,
  signal receive set=term peer=/opt/zimbra/bin/zmconfigdctl,
  signal receive set=term peer=/opt/zimbra/libexec/zmmailboxdmgr,
  signal send set=quit peer=unconfined,

  ptrace read peer=/usr/lib/libreoffice/program/soffice,
  ptrace read peer=unconfined,
  ptrace read peer=zimbra_jvm//jspawnhelper,

  unix (send, receive) type=stream,

  / r,
  /bin/bash mr,
  /dev/tty rw,
  /etc/timezone r,
  /lib/x86_64-linux-gnu/ld-*.so mr,
  /opt/zimbra/ r,
  /opt/zimbra/backup/ r,
  /opt/zimbra/common/conf/ r,
  /opt/zimbra/common/conf/** r,
  /opt/zimbra/common/etc/ r,
  /opt/zimbra/common/etc/* r,
  /opt/zimbra/common/etc/** r,
  /opt/zimbra/common/jetty_home/lib/** r,
  /opt/zimbra/common/lib/jvm/openjdk-*/** mr,
  /opt/zimbra/common/lib/jvm/openjdk-*/bin/java mr,
  /opt/zimbra/common/lib/jvm/openjdk-*/lib/** mr,
  /opt/zimbra/common/lib/jvm/openjdk-*/lib/jspawnhelper Cx -> jspawnhelper,
  /opt/zimbra/common/lib/jvm/openjdk-*/lib/lib*so* mr,
  /opt/zimbra/common/lib/jvm/openjdk-*/lib/server/*.so mr,
  /opt/zimbra/common/lib/jylibs/* r,
  /opt/zimbra/common/lib/lib*so* mr,
  /opt/zimbra/conf/ r,
  /opt/zimbra/conf/** r,
  /opt/zimbra/data/ldap/state/run/ldapi rw,
  /opt/zimbra/data/spamassassin/ r,
  /opt/zimbra/data/tmp/** rw,
  /opt/zimbra/jetty_base/** w,
  /opt/zimbra/jetty_base/common/endorsed/ rw,
  /opt/zimbra/jetty_base/common/endorsed/* rw,
  /opt/zimbra/jetty_base/etc/* r,
  /opt/zimbra/jetty_base/modules/ rw,
  /opt/zimbra/jetty_base/modules/* rw,
  /opt/zimbra/jetty_base/resources/ rw,
  /opt/zimbra/jetty_base/start.d/ rw,
  /opt/zimbra/jetty_base/start.d/* rw,
  /opt/zimbra/jetty_base/work/ rw,
  /opt/zimbra/lib/** r,
  /opt/zimbra/lib/lib*so* mr,
  /opt/zimbra/libexec/zmconfigd r,
  /opt/zimbra/log/ r,
  /opt/zimbra/log/* rw,
  /opt/zimbra/zimlets-network/** rw,
  /opt/zimbra/zimlets/* r,
  /opt/zimbra/zmstat/* w,
  /proc/*/net/if_inet6 r,
  /proc/*/stat r,
  /proc/cgroups r,
  /proc/stat r,
  /proc/sys/net/core/somaxconn r,
  /proc/sys/vm/overcommit_memory r,
  /run/systemd/journal/dev-log rw,
  /sys/fs/cgroup/**/cpu.* r,
  /sys/fs/cgroup/*/system.slice/cpu.* r,
  /sys/fs/cgroup/*/user.slice/*.slice/cpu.* r,
  /sys/fs/cgroup/*/user.slice/*/cpu.cfs_quota_us r,
  /sys/fs/cgroup/memory/memory.* r,
  /tmp/ r,
  /tmp/** w,
  owner /opt/zimbra/* r,
  owner /opt/zimbra/.ssh/ r,
  owner /opt/zimbra/.ssh/* r,
  owner /opt/zimbra/.zmprov_history w,
  owner /opt/zimbra/backup/** rw,
  owner /opt/zimbra/backup/** wl,
  owner /opt/zimbra/backup/accounts/** rw,
  owner /opt/zimbra/backup/items/** rw,
  owner /opt/zimbra/common/conf/* r,
  owner /opt/zimbra/common/conf/*.re w,
  owner /opt/zimbra/common/conf/master.cf w,
  owner /opt/zimbra/common/etc/java/* r,
  owner /opt/zimbra/common/jetty_home/* r,
  owner /opt/zimbra/common/jetty_home/** r,
  owner /opt/zimbra/common/jetty_home/lib/** mr,
  owner /opt/zimbra/common/lib/jylibs/* rw,
  owner /opt/zimbra/conf/** w,
  owner /opt/zimbra/data/auth/ r,
  owner /opt/zimbra/data/auth/* r,
  owner /opt/zimbra/data/auth/* w,
  owner /opt/zimbra/data/auth/db.properties.new rw,
  owner /opt/zimbra/data/auth/db.script.new rw,
  owner /opt/zimbra/data/auth/db.tmp/ rw,
  owner /opt/zimbra/data/drive/ r,
  owner /opt/zimbra/data/drive/* rw,
  owner /opt/zimbra/data/drive/db.tmp/ rw,
  owner /opt/zimbra/data/mailboxd/** rw,
  owner /opt/zimbra/data/mailboxd/.lock k,
  owner /opt/zimbra/data/spamassassin/localrules/salocal.cf rw,
  owner /opt/zimbra/data/tmp/*.so mrw,
  owner /opt/zimbra/data/tmp/*.tmp mrw,
  owner /opt/zimbra/data/tmp/jna/*.tmp mrw,
  owner /opt/zimbra/db/* r,
  owner /opt/zimbra/index/** rw,
  owner /opt/zimbra/index/**/ r,
  owner /opt/zimbra/jetty_base/** r,
  owner /opt/zimbra/jetty_base/etc/* rw,
  owner /opt/zimbra/jetty_base/webapps/*/WEB-INF/*.xml rw,
  owner /opt/zimbra/redolog/ r,
  owner /opt/zimbra/redolog/* rw,
  owner /opt/zimbra/redolog/archive/ r,
  owner /opt/zimbra/ssl/zimbra/ r,
  owner /opt/zimbra/ssl/zimbra/* r,
  owner /opt/zimbra/ssl/zimbra/** r,
  owner /opt/zimbra/ssl/zimbra/*/ r,
  owner /opt/zimbra/ssl/zimbra/ca/* r,
  owner /opt/zimbra/ssl/zimbra/ca/newcerts/* r,
  owner /opt/zimbra/store/** l,
  owner /opt/zimbra/store/** r,
  owner /opt/zimbra/store/** w,
  owner /opt/zimbra/store/incoming/* w,
  owner /opt/zimbra/zimlets-deployed/ r,
  owner /opt/zimbra/zimlets-deployed/** rw,
  owner /opt/zimbra/zmstat/* r,
  owner /opt/zimbra/zmstat/*/ w,
  owner /opt/zimbra/zmstat/*/*.csv.gz w,
  owner /opt/zimbra/zmstat/*/soap.csv.gz w,
  owner /opt/zimbra/zmstat/*/sql.csv.gz w,
  owner /opt/zimbra/zmstat/*/threads.csv.gz w,
  owner /proc/*/cgroup r,
  owner /proc/*/coredump_filter rw,
  owner /proc/*/fd/ r,
  owner /proc/*/mountinfo r,
  owner /tmp/** rw,
  owner /tmp/** wk,
  owner /tmp/hsperfdata_zimbra/** wk,


  profile jspawnhelper {
    #include <abstractions/base>
    #include <abstractions/consoles>
    #include <abstractions/nameservice>
    #include <abstractions/zimbra-bash>
    #include <abstractions/zimbra-ptrace>

    unix (send, receive) type=stream,

    deny owner /opt/zimbra/backup/accounts/** w,

    /bin/dash mrix,
    /bin/stty mrix,
    /lib/x86_64-linux-gnu/ld-*.so mr,
    /opt/zimbra/bin/ldap Ux,
    /opt/zimbra/bin/postconf Ux,
    /opt/zimbra/bin/zmamavisdctl Ux,
    /opt/zimbra/bin/zmantispamctl Ux,
    /opt/zimbra/bin/zmclamdctl Ux,
    /opt/zimbra/bin/zmconvertctl Ux,
    /opt/zimbra/bin/zmdnscachectl Ux,
    /opt/zimbra/bin/zmloggerctl Ux,
    /opt/zimbra/bin/zmmailboxdctl Ux,
    /opt/zimbra/bin/zmmtactl Ux,
    /opt/zimbra/bin/zmopendkimctl Ux,
    /opt/zimbra/bin/zmsaslauthdctl Ux,
    /opt/zimbra/bin/zmspellctl Ux,
    /opt/zimbra/bin/zmstatctl Ux,
    /opt/zimbra/bin/zmstorectl Ux,
    /opt/zimbra/bin/zmswatchctl Ux,
    /opt/zimbra/common/jetty_home/* r,
    /opt/zimbra/common/jetty_home/lib/* r,
    /opt/zimbra/common/jetty_home/lib/** r,
    /opt/zimbra/common/lib/jvm/openjdk-*/lib/jspawnhelper mr,
    /opt/zimbra/common/lib/jvm/openjdk-*/lib/modules r,
    /opt/zimbra/data/ldap/state/run/ldapi rw,
    /opt/zimbra/jetty_base/** r,
    /opt/zimbra/lib/**.jar r,
    /opt/zimbra/libexec/zmrrdfetch Px,
    /opt/zimbra/zimlets-deployed/*/*.properties r,
    /proc/tty/drivers r,
    /run/systemd/journal/dev-log rw,
    /sys/fs/cgroup/**/cpu.* r,
    /sys/fs/cgroup/memory/memory.limit_in_bytes r,
    /sys/fs/cgroup/memory/memory.stat r,
    /usr/lib/libreoffice/program/oosplash Px,
    /usr/lib/libreoffice/program/soffice Px,
    owner /opt/zimbra/.ssh/zimbra_identity r,
    owner /opt/zimbra/.zmprov_history rw,
    owner /opt/zimbra/backup/* rw,
    owner /opt/zimbra/backup/accounts/** r,
    owner /opt/zimbra/backup/accounts/**/*.tmp w,
    owner /opt/zimbra/backup/items/** rw,
    owner /opt/zimbra/common/conf/* r,
    owner /opt/zimbra/common/conf/master.cf w,
    owner /opt/zimbra/common/conf/tag_as_foreign.re w,
    owner /opt/zimbra/conf/* r,
    owner /opt/zimbra/conf/** r,
    owner /opt/zimbra/conf/** w,
    owner /opt/zimbra/conf/opendkim.conf rw,
    owner /opt/zimbra/conf/zmconfigd/*.cf r,
    owner /opt/zimbra/data/auth/db.data rw,
    owner /opt/zimbra/data/auth/db.lck rw,
    owner /opt/zimbra/data/auth/db.log a,
    owner /opt/zimbra/data/drive/db.data rw,
    owner /opt/zimbra/data/drive/db.lck rw,
    owner /opt/zimbra/data/drive/db.log a,
    owner /opt/zimbra/data/mailboxd/.lock rw,
    owner /opt/zimbra/data/mailboxd/imap-active-session-cache_*/** rw,
    owner /opt/zimbra/data/mailboxd/imap-inactive-session-cache_*/** rw,
    owner /opt/zimbra/data/mailboxd/sync-state-item-cache_*/** rw,
    owner /opt/zimbra/data/spamassassin/localrules/*.cf rw,
    owner /opt/zimbra/data/tmp/libreoffice/conversion_cache/* w,
    owner /opt/zimbra/data/tmp/upload/*.tmp r,
    owner /opt/zimbra/data/tmp/upload/*.tmp w,
    owner /opt/zimbra/index/0/**/*.cfs r,
    owner /opt/zimbra/index/0/**/*.fdt r,
    owner /opt/zimbra/index/0/**/*.fdt w,
    owner /opt/zimbra/index/0/**/*.fdx r,
    owner /opt/zimbra/index/0/**/*.fdx w,
    owner /opt/zimbra/index/0/**/*.frq r,
    owner /opt/zimbra/index/0/**/*.nrm r,
    owner /opt/zimbra/index/0/**/*.prx r,
    owner /opt/zimbra/index/0/**/*.tis r,
    owner /opt/zimbra/jetty_base/etc/* rw,
    owner /opt/zimbra/jetty_base/modules/setuid.mod rw,
    owner /opt/zimbra/jetty_base/start.d/setuid.ini rw,
    owner /opt/zimbra/jetty_base/webapps/service/WEB-INF/web.xml rw,
    owner /opt/zimbra/jetty_base/webapps/zimbra/WEB-INF/jetty-env.xml rw,
    owner /opt/zimbra/jetty_base/webapps/zimbra/WEB-INF/web.xml rw,
    owner /opt/zimbra/jetty_base/webapps/zimbraAdmin/WEB-INF/*.xml rw,
    owner /opt/zimbra/jetty_base/webapps/zimlet/WEB-INF/web.xml rw,
    owner /opt/zimbra/log/access_log.* a,
    owner /opt/zimbra/log/activity.log a,
    owner /opt/zimbra/log/audit.log a,
    owner /opt/zimbra/log/ews.log a,
    owner /opt/zimbra/log/mailbox.log a,
    owner /opt/zimbra/log/searchstat.log a,
    owner /opt/zimbra/log/sync.log a,
    owner /opt/zimbra/log/syncstate.log a,
    owner /opt/zimbra/log/synctrace.log a,
    owner /opt/zimbra/log/trace_log.* a,
    owner /opt/zimbra/log/wbxml.log a,
    owner /opt/zimbra/log/zmconfigd-audit.log a,
    owner /opt/zimbra/log/zmconfigd-log4j.log a,
    owner /opt/zimbra/log/zmmailboxd.out a,
    owner /opt/zimbra/redolog/redo.log rw,
    owner /opt/zimbra/store/0/**/*.msg r,
    owner /opt/zimbra/store/incoming/* w,
    owner /opt/zimbra/zimlets-deployed/com_zextras_zextras/* r,
    owner /opt/zimbra/zimlets-deployed/com_zimbra_adminversioncheck/com_zimbra_adminversioncheck.properties r,
    owner /opt/zimbra/zimlets-deployed/com_zimbra_smime/* r,
    owner /proc/*/fd/ r,
    owner /tmp/* rw,

  }
}
